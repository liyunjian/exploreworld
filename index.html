<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPXè½¨è¿¹æ¢ç´¢åœ°å›¾</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #map { 
            width: 100vw; 
            height: 100vh; 
            margin: 0; 
            padding: 0; 
        }
        
        #legend-card {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: linear-gradient(145deg, rgba(30, 30, 35, 0.85) 0%, rgba(15, 15, 20, 0.9) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            padding: 12px 24px 14px 24px;
            max-width: 96vw;
            min-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        #legend-card:hover {
            transform: translateX(-50%) translateY(-4px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                        0 0 60px rgba(118, 56, 255, 0.3);
        }
        
        #legend-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #e5e7eb;
            letter-spacing: -0.01em;
            line-height: 0.9;
            margin-bottom: 8px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        #legend-title span {
            font-weight: 700;
            font-size: 1.15em;
            background: linear-gradient(90deg, #818cf8, #c084fc, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient-flow 5s ease infinite;
            background-size: 200% auto;
        }
        
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #legend {
            width: 100%;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
        }
        
        #legend span {
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
            color: #d1d5db;
            flex: 0 0 auto;
        }
        
        /* è¿”å›ä¸»é¡µæŒ‰é’®æ ·å¼ */
        #home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 15;
            background: linear-gradient(145deg, rgba(30, 30, 35, 0.9) 0%, rgba(15, 15, 20, 0.95) 100%);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 12px;
            text-decoration: none;
            color: #e5e7eb;
            font-size: 12px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-align: center;
        }
        
        #home-button:hover {
            transform: translateY(-2px) scale(1.05);
            background: linear-gradient(145deg, rgba(40, 40, 50, 0.95) 0%, rgba(25, 25, 35, 1) 100%);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                        0 0 30px rgba(99, 102, 241, 0.3);
            color: #ffffff;
        }
        
        #home-button:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        #home-button::before {
            content: "ğŸ ";
            font-size: 18px;
            line-height: 1;
        }
        
        #legend span:hover {
            color: #fff;
            text-shadow: 0 0 8px rgba(255,255,255,0.5);
        }
        
        #legend span > span {
            width: 18px;
            height: 4px;
            border-radius: 2px;
            margin-right: 8px;
            display: inline-block;
            box-shadow: 0 0 8px 1px var(--glow-color, transparent), 
                        0 0 4px var(--glow-color-2, transparent);
            transition: all 0.3s ease;
        }
        
        #legend span:hover > span {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 900px) and (min-width: 601px) {
            #legend-card {
                min-width: 340px;
                padding: 8px 16px 10px 16px;
                border-radius: 14px;
            }
            #legend-title {
                font-size: 1.2em;
                margin-bottom: 6px;
            }
            #legend {
                gap: 16px;
            }
            #legend span {
                font-size: 13px;
            }
            #legend span > span {
                width: 16px;
                height: 4px;
                margin-right: 8px;
                display: inline-block;
            }
            
            /* ä¸­ç­‰å±å¹•ä¸Šè¿”å›ä¸»é¡µæŒ‰é’®ç¨å¾®ç¼©å° */
            #home-button {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            #home-button::before {
                font-size: 16px;
            }
        }
        
        @media (max-width: 600px) {
            #legend-card {
                min-width: 280px;
                padding: 6px 10px 8px 10px;
                border-radius: 12px;
                margin: 0 8px;
            }
            #legend-title {
                font-size: 1.0em;
                margin-bottom: 4px;
            }
            #legend {
                gap: 12px;
                flex-wrap: nowrap;
            }
            #legend span {
                font-size: 11px;
                display: flex;
                align-items: center;
            }
            #legend span > span {
                width: 14px;
                height: 3px;
                margin-right: 6px;
                display: inline-block;
                flex-shrink: 0;
            }
            
            /* æ‰‹æœºä¸Šè¿”å›ä¸»é¡µæŒ‰é’®æ˜¾è‘—ç¼©å° */
            #home-button {
                top: 20px;
                left: 8px;
                padding: 5px 8px;
                font-size: 10px;
                border-radius: 8px;
                gap: 2px;
            }
            
            #home-button::before {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- è¿”å›ä¸»é¡µæŒ‰é’® -->
    <a href="https://www.liyunjian.com" id="home-button" target="_blank">è¿”å›ä¸»é¡µ</a>
    
    <div id="legend-card">
        <div id="legend-title">
            äººç”Ÿå·²æ¢ç´¢åœ°é¢<span style="color:#f59e0b;">è®¡ç®—ä¸­...</span>
            <div style="font-size:0.9em;font-weight:400;color:#9ca3af;margin-top:3px;text-shadow:none;">æ­£åœ¨åˆ†æè½¨è¿¹æ•°æ®</div>
        </div>
        <div id="legend">
            <span style="--glow-color: rgba(239, 68, 68, 0.7); --glow-color-2: rgba(239, 68, 68, 0.5);"><span style="background:#ef4444;"></span>Road</span>
            <span style="--glow-color: rgba(16, 185, 129, 0.7); --glow-color-2: rgba(16, 185, 129, 0.5);"><span style="background:#10b981;"></span>Train</span>
            <span style="--glow-color: rgba(59, 130, 246, 0.7); --glow-color-2: rgba(59, 130, 246, 0.5);"><span style="background:#3b82f6;"></span>Plane</span>
            <span style="--glow-color: rgba(245, 158, 11, 0.7); --glow-color-2: rgba(245, 158, 11, 0.5);"><span style="background:#f59e0b;"></span>Other</span>
        </div>
    </div>
    
    <div id="map"></div>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        // é…ç½®å¸¸é‡
        const CHINA_CENTER = [104.066, 35.86]; // ä¸­å›½å‡ ä½•ä¸­å¿ƒåæ ‡
        const DEFAULT_ZOOM = 4; // åˆå§‹ç¼©æ”¾çº§åˆ«
        const TARGET_ZOOM = 2; // ç›®æ ‡ç¼©æ”¾çº§åˆ«ï¼ˆå…¨çƒè§†å›¾ï¼‰
        
        /**
         * ä»JSONç¼“å­˜åŠ è½½æŒ‡æ ‡æ•°æ®
         */
        async function loadMetrics() {
            console.log('æ­£åœ¨ä»ç¼“å­˜åŠ è½½è®¡ç®—ç»“æœ...');
            
            try {
                const response = await fetch(`cache/metrics.json?t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (typeof data.explored_area_km2 === 'undefined' || 
                    typeof data.earth_percentage === 'undefined') {
                    throw new Error('ç¼“å­˜æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                console.log('æˆåŠŸåŠ è½½è®¡ç®—ç»“æœ:', data);
                
                return {
                    exploredArea: data.explored_area_km2,
                    percentage: data.earth_percentage,
                    totalFiles: data.total_files,
                    totalPoints: data.total_points,
                    uniquePoints: data.unique_points,
                    calculationTime: data.calculation_time,
                    files: data.files
                };

            } catch (error) {
                console.error('åŠ è½½ç¼“å­˜å¤±è´¥:', error);
                
                let errorMessage;
                if (error.message.includes('404') || error.message.includes('HTTPé”™è¯¯')) {
                    errorMessage = 'ç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ calculate_metrics.py ç”Ÿæˆç¼“å­˜';
                } else if (error.message.includes('æ ¼å¼ä¸æ­£ç¡®')) {
                    errorMessage = 'ç¼“å­˜æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°ç”Ÿæˆç¼“å­˜';
                } else {
                    errorMessage = 'åŠ è½½ç¼“å­˜æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: ' + error.message;
                }
                
                return {
                    exploredArea: 0,
                    percentage: 0,
                    totalFiles: 0,
                    totalPoints: 0,
                    uniquePoints: 0,
                    calculationTime: null,
                    files: [],
                    error: errorMessage
                };
            }
        }

        /**
         * ä»JSONç¼“å­˜åŠ è½½è½¨è¿¹æ•°æ®ï¼ˆæ”¯æŒé™æ€é…ç½®ï¼‰
         */
        async function loadTracksData() {
            console.log('æ­£åœ¨ä»ç¼“å­˜åŠ è½½è½¨è¿¹æ•°æ®...');

            try {
                // å…ˆåŠ è½½é™æ€é…ç½®æ–‡ä»¶ï¼Œç¡®å®šæ•°æ®ç»“æ„
                console.log('æ­£åœ¨è¯»å–é™æ€é…ç½®æ–‡ä»¶...');
                const configResponse = await fetch(`cache/data_config.json?t=${Date.now()}`);
                
                if (!configResponse.ok) {
                    throw new Error(`é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥: ${configResponse.status}`);
                }

                const config = await configResponse.json();
                console.log('é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ:', config);

                if (config.data_type === 'single') {
                    // å•ä¸ªæ–‡ä»¶æ¨¡å¼
                    console.log('æ£€æµ‹åˆ°å•ä¸ªæ–‡ä»¶æ¨¡å¼...');
                    const response = await fetch(`cache/${config.single_file}?t=${Date.now()}`);
                    
                    if (!response.ok) {
                        throw new Error(`æ•°æ®æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('æˆåŠŸåŠ è½½å•ä¸ªè½¨è¿¹æ–‡ä»¶:', {
                        trackTypes: Object.keys(data.tracks),
                        totalTracks: Object.values(data.tracks).reduce((sum, track) => sum + (track.points_count || 0), 0),
                        bounds: data.bounds
                    });
                    
                    return data;
                    
                } else if (config.data_type === 'chunked') {
                    // åˆ†ç‰‡æ–‡ä»¶æ¨¡å¼
                    console.log(`æ£€æµ‹åˆ°åˆ†ç‰‡æ–‡ä»¶æ¨¡å¼ï¼Œå…± ${config.chunks.length} ä¸ªåˆ†ç‰‡...`);

                    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰åˆ†ç‰‡
                    const chunkPromises = config.chunks.map(async (chunkFile) => {
                        const chunkResponse = await fetch(`cache/${chunkFile}?t=${Date.now()}`);
                        if (!chunkResponse.ok) {
                            throw new Error(`åˆ†ç‰‡æ–‡ä»¶åŠ è½½å¤±è´¥: ${chunkFile}`);
                        }
                        return await chunkResponse.json();
                    });

                    const chunks = await Promise.all(chunkPromises);
                    console.log('æ‰€æœ‰åˆ†ç‰‡åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå¹¶æ•°æ®...');

                    // åˆå¹¶åˆ†ç‰‡æ•°æ®
                    const mergedData = {
                        metrics: chunks[0].metrics,
                        tracks: {},
                        bounds: chunks[0].bounds,
                        generated_at: chunks[0].generated_at,
                        version: chunks[0].version,
                        chunked: true,
                        total_chunks: chunks.length
                    };

                    // åˆå¹¶å„ä¸ªè½¨è¿¹ç±»å‹çš„æ•°æ®
                    for (const chunk of chunks) {
                        Object.keys(chunk.tracks).forEach(trackType => {
                            mergedData.tracks[trackType] = chunk.tracks[trackType];
                        });
                    }

                    console.log('æˆåŠŸåˆå¹¶åˆ†ç‰‡æ•°æ®:', {
                        trackTypes: Object.keys(mergedData.tracks),
                        totalTracks: Object.values(mergedData.tracks).reduce((sum, track) => sum + (track.points_count || 0), 0),
                        bounds: mergedData.bounds,
                        totalChunks: mergedData.total_chunks
                    });
                    
                    return mergedData;
                    
                } else {
                    throw new Error(`æœªçŸ¥çš„æ•°æ®ç±»å‹: ${config.data_type}`);
                }

            } catch (error) {
                console.error('åŠ è½½è½¨è¿¹æ•°æ®å¤±è´¥:', error);
                return null;
            }
        }
        
        /**
         * æ›´æ–°å›¾ä¾‹æ ‡é¢˜æ˜¾ç¤º
         */
        function updateLegendTitle(metrics) {
            const titleEl = document.querySelector('#legend-title');
            if (!titleEl) return;
            
            const spanEl = titleEl.querySelector('span');
            const divEl = titleEl.querySelector('div');
            
            if (metrics.error) {
                spanEl.innerHTML = '<span style="color:#ef4444;">æœªæ‰¾åˆ°ç¼“å­˜</span>';
                divEl.innerHTML = `<small style="color:#94a3b8;">${metrics.error}</small>`;
            } else {
                spanEl.textContent = `${metrics.exploredArea.toFixed(6)}kmÂ²`;
                divEl.textContent = `æ˜¯åœ°çƒçš„${metrics.percentage.toFixed(15)}%`;
                
                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                if (metrics.totalFiles) {
                    console.log('ğŸ“Š æ¢ç´¢æ•°æ®è¯¦æƒ…:');
                    console.log(`   æ–‡ä»¶æ•°é‡: ${metrics.totalFiles}`);
                    console.log(`   æ€»è½¨è¿¹ç‚¹: ${metrics.totalPoints}`);
                    console.log(`   å»é‡å: ${metrics.uniquePoints}`);
                    console.log(`   è®¡ç®—æ—¶é—´: ${metrics.calculationTime || 'æœªçŸ¥'}`);
                }
            }
        }
        
        /**
         * æ ¹æ®è½¨è¿¹èŒƒå›´è®¡ç®—åˆé€‚çš„ç¼©æ”¾çº§åˆ«
         */
        function calculateZoomLevel(bounds) {
            const lngSpan = bounds.max_lng - bounds.min_lng;
            const latSpan = bounds.max_lat - bounds.min_lat;
            const maxSpan = Math.max(lngSpan, latSpan);
            
            if (maxSpan > 40) return 2.5;      // è·¨æ´²é™…è½¨è¿¹
            else if (maxSpan > 30) return 3.0; // è·¨å›½è½¨è¿¹  
            else if (maxSpan > 20) return 3.5; // å¤§èŒƒå›´å›½å†…è½¨è¿¹
            else if (maxSpan > 10) return 4.2; // ä¸­èŒƒå›´è½¨è¿¹
            else if (maxSpan > 5) return 5.0;  // å°èŒƒå›´è½¨è¿¹
            else return 6.0;                   // æœ¬åœ°è½¨è¿¹
        }
        
        /**
         * æ¸²æŸ“è½¨è¿¹æ•°æ®åˆ°åœ°å›¾
         */
        function renderTracks(map, tracksData) {
            console.log('å¼€å§‹æ¸²æŸ“è½¨è¿¹...');
            
            Object.entries(tracksData.tracks).forEach(([trackType, trackData]) => {
                if (!trackData.files || trackData.files.length === 0) {
                    console.log(`è·³è¿‡ ${trackType}: æ— æ•°æ®`);
                    return;
                }

                console.log(`æ¸²æŸ“ ${trackType}: ${trackData.points_count || 0} ä¸ªç‚¹, ${trackData.lines_count || 0} æ¡çº¿`);

                const color = trackData.color;
                const displayType = trackData.display_type;

                if (displayType === 'points' && trackData.points.features.length > 0) {
                    // æ·»åŠ ç‚¹æ•°æ®æºå’Œå›¾å±‚
                    map.addSource(`${trackType}-points`, {
                        type: 'geojson',
                        data: trackData.points
                    });
                    
                    map.addLayer({
                        id: `${trackType}-points-layer`,
                        type: 'circle',
                        source: `${trackType}-points`,
                        paint: {
                            'circle-radius': [
                                'interpolate', ['linear'], ['zoom'],
                                2, 1,
                                12, 2,
                                18, 5
                            ],
                            'circle-color': color,
                            'circle-opacity': 0.8
                        }
                    });
                    
                } else if (displayType === 'lines' && trackData.lines.features.length > 0) {
                    // æ·»åŠ çº¿æ•°æ®æºå’Œå›¾å±‚
                    map.addSource(`${trackType}-lines`, {
                        type: 'geojson',
                        data: trackData.lines,
                        lineMetrics: true // å¯ç”¨çº¿æ®µæŒ‡æ ‡ï¼Œæœ‰åŠ©äºè·¨æ—¥ç•Œçº¿æ¸²æŸ“
                    });
                    
                    map.addLayer({
                        id: `${trackType}-lines-layer`,
                        type: 'line',
                        source: `${trackType}-lines`,
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': color,
                            'line-width': [
                                'interpolate', ['linear'], ['zoom'],
                                2, 1,
                                8, 2,
                                12, 3
                            ],
                            'line-opacity': 0.9
                        }
                    });
                }
            });
            
            console.log('âœ… è½¨è¿¹æ¸²æŸ“å®Œæˆ');
        }
        
        /**
         * è°ƒæ•´åœ°å›¾è§†å›¾åˆ°åˆé€‚ä½ç½®
         */
        function adjustMapView(map, tracksData) {
            // æ‰§è¡Œç¼©æ”¾åŠ¨ç”»ï¼Œä»4åˆ°2ï¼Œä½†ä¿æŒä¸­å¿ƒä½ç½®ä¸å˜
            console.log('æ‰§è¡Œç¼©æ”¾åŠ¨ç”»ï¼šä»çº§åˆ«4åˆ°çº§åˆ«2ï¼Œä¿æŒä¸­å›½å±…ä¸­');
            setTimeout(() => {
                map.flyTo({
                    center: CHINA_CENTER,  // ä¿æŒä¸­å¿ƒä½ç½®ä¸å˜
                    zoom: TARGET_ZOOM,     // ç¼©æ”¾åˆ°å…¨çƒè§†å›¾
                    duration: 1000,        // 2ç§’åŠ¨ç”»æ—¶é•¿
                    curve: 0.2,              // çº¿æ€§ç¼©æ”¾æ›²çº¿
                    easing: (t) => t       // çº¿æ€§ç¼“åŠ¨ï¼Œé¿å…è½¬åŠ¨æ•ˆæœ
                });
            }, 30);
        }

        // åˆå§‹åŒ–åœ°å›¾
        mapboxgl.accessToken = '';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/yunjian/cmfxy24sw000j01s7354u3hqh',
            center: CHINA_CENTER,
            zoom: DEFAULT_ZOOM,
            minZoom: 2,    // å¯ä»¥ç¼©å°åˆ°å…¨çƒè§†å›¾
            maxZoom: 12    // é™åˆ¶æœ€å¤§æ”¾å¤§å€æ•°
        });

        // åœ°å›¾åŠ è½½å®Œæˆåçš„å¤„ç†
        map.on('load', function() {
            // å¹¶è¡ŒåŠ è½½æ•°æ®
            Promise.all([
                loadMetrics(),
                loadTracksData()
            ]).then(([metrics, tracksData]) => {
                // æ›´æ–°UIæ˜¾ç¤º
                updateLegendTitle(metrics);
                
                // æ¸²æŸ“è½¨è¿¹æ•°æ®
                if (tracksData) {
                    renderTracks(map, tracksData);
                }
                
                // è°ƒæ•´åœ°å›¾è§†å›¾
                adjustMapView(map, tracksData);
                
            }).catch(error => {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                const titleEl = document.querySelector('#legend-title');
                if (titleEl) {
                    titleEl.querySelector('span').innerHTML = '<span style="color:#ef4444;">åŠ è½½å¤±è´¥</span>';
                    titleEl.querySelector('div').textContent = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                }
            });
        });
    </script>
</body>
</html>
